# Strictly, Listen and NameVirtualHost should be set by modifying the
# [:apache][:listen_ports] attribute in the setup_base_images recipe, but that
# would somehow require rewriting ports.conf (listen.conf on SUSE), so we'd
# need to either set that attribute *before* including the apache2 recipe
# (in which case the provisioner port will be the *only* port apache listens
# on, preventing using apache for any other purpose), or we need to rewrite
# ports.conf to include whatever's already there *plus* the provisioner
# port.  The latter is the best behaved, but frankly strikes me as messy.
# So until I come up with something better, here we go:
Listen <%=@port%>
NameVirtualHost *:<%=@port%>

<VirtualHost *:<%=@port%>>
    <IfModule mod_cache.c>
           CacheDefaultExpire 86400
           CacheIgnoreNoLastMod On
           CacheMaxExpire 604800
           CacheStoreNoStore On

           <IfModule mod_disk_cache.c>
                   CacheRoot /var/cache/apache2/
                   CacheEnable disk /
                   CacheDirLevels 3
                   CacheDirLength 2
                   CacheMinFileSize 512
           </IfModule>
           CacheDisable <%= @no_cache %>
    </IfModule>

    ErrorLog <%= @errorlog %>
    CustomLog <%= @logfile %> combined

    HostnameLookups Off
    UseCanonicalName Off

    ProxyRequests On
    ProxyVia On
    <% if @upstream_proxy != "" -%>
    ProxyRemote http "<%= @upstream_proxy %>"
    <% end -%>
    <Proxy *>
            AddDefaultCharset off
            Order deny,allow
            Deny from all
            <% @allowed_clients.each do |client| -%>
            Allow from <%= client %>
            <% end -%>
    </Proxy>

</VirtualHost>

